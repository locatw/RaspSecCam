require 'fileutils'

PRODUCT = "RaspSecCam"

SERVER_NAMESPACE = "server"
namespace SERVER_NAMESPACE do
  TARGET = "rasp-sec-cam-server"
  BIN_DIR = "bin"
  BUILD_DIR = "build"

  task :setup do |t|
    FileUtils.mkdir_p(BUILD_DIR) unless Dir.exist?(BUILD_DIR) 
  end

  desc "Build executable"
  task :build => :setup do |t|
    cd BUILD_DIR do
      sh "cmake -DCMAKE_INSTALL_PREFIX=.. .."
      sh "make"
      sh "make install"
    end
  end
  
  desc "Rebuild executable"
  task :rebuild do |t|
    Rake::Task["#{SERVER_NAMESPACE}:clobber"].invoke
    Rake::Task["#{SERVER_NAMESPACE}:build"].invoke
  end

  desc "Remove any temporary products"
  task :clean do |t|
    rm_r BUILD_DIR if File.exists?(BUILD_DIR)
  end
  
  desc "Remove any generated file"
  task :clobber do |t|
    Rake::Task["#{SERVER_NAMESPACE}:clean"].invoke
    rm_r BIN_DIR if File.exists?(BIN_DIR)
  end

  desc "Deploy executables to raspberry pi"
  task :deploy => :build do |t|
    user = ENV["RASPI_USER"]
    host = ENV["RASPI_HOST"]
   
    raspi_path = "#{user}@#{host}"
    src_path = "#{BIN_DIR}/#{TARGET}"
    dest_path = "#{raspi_path}:~/dev/#{PRODUCT}/"
    sh "rsync #{src_path} #{dest_path}"
  end
end
